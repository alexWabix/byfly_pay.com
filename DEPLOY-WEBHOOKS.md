# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é —Å–∏—Å—Ç–µ–º—ã –≤–µ–±—Ö—É–∫–æ–≤

## üéØ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:

### 1. ‚úÖ –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑
- API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤–µ–±—Ö—É–∫–∏
- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (user_id, order_id –∏ —Ç.–¥.)

### 2. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤–µ–±—Ö—É–∫–æ–≤
- 5 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π (paid, partially_paid, cancelled, refunded, expired)
- HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ (–¥–æ 3 —Ä–∞–∑)
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3. ‚úÖ –°—É–ø–µ—Ä-–±—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É (–Ω–µ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É!)
- Lock-—Ñ–∞–π–ª –∑–∞—â–∏—Ç–∞
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –æ–ø–ª–∞—Ç—É/–æ—Ç–º–µ–Ω—É

### 4. ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
- –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö
- –í–µ–±—Ö—É–∫ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º

### 5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
- –ü—Ä–∏–º–µ—Ä—ã –Ω–∞ PHP, JS, Python
- –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö endpoints

---

## üì¶ –®–∞–≥–∏ –¥–µ–ø–ª–æ—è:

### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—Ä—Ö–∏–≤
```bash
scp deploy.zip user@byfly-pay.com:/var/www/
```

### –®–∞–≥ 2: –†–∞—Å–ø–∞–∫—É–π—Ç–µ
```bash
cd /var/www/byfly-pay.com
unzip -o deploy.zip
```

### –®–∞–≥ 3: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
```bash
# –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤
mysql -u payments -p payments < database/migration-webhooks.sql

# –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞)
mysql -u payments -p payments < database/migration-refunds.sql
```

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CRON
```bash
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏ (–∑–∞–º–µ–Ω–∏—Ç–µ –ø—É—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π):

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
* * * * * /usr/bin/php /var/www/byfly-pay.com/api/cron/check-active-payments.php >> /var/log/byfly-payments.log 2>&1

# –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00)
0 3 * * * /usr/bin/php /var/www/byfly-pay.com/api/cron/cleanup-expired-payments.php >> /var/log/byfly-cleanup.log 2>&1
```

### –®–∞–≥ 5: –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
```bash
chmod +x api/cron/*.php
chmod 755 api/cron/
```

### –®–∞–≥ 6: –°–æ–∑–¥–∞–π—Ç–µ –ª–æ–≥–∏
```bash
sudo touch /var/log/byfly-payments.log
sudo touch /var/log/byfly-cleanup.log
sudo chown www-data:www-data /var/log/byfly-*.log
```

### –®–∞–≥ 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é
php api/cron/check-active-payments.php

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# === CHECK ACTIVE PAYMENTS - CONTINUOUS MODE ===
# [2025-12-26 15:00:00] Starting continuous monitoring...
# [2025-12-26 15:00:00] Check #1: Found 0 active payment(s)
# [2025-12-26 15:00:00] No active payments. Exiting after 1 checks.
# [2025-12-26 15:00:00] Completed after 0 seconds (1 checks)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API:

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å –≤–µ–±—Ö—É–∫–æ–º:

```bash
curl -X POST https://byfly-pay.com/api/payment/init \
  -H "Content-Type: application/json" \
  -H "X-API-Token: –í–ê–®_API_–¢–û–ö–ï–ù" \
  -d '{
    "amount": 500,
    "currency": "KZT",
    "description": "–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂",
    "webhook_url": "https://webhook.site/YOUR-ID",
    "webhook_secret": "test_secret_key",
    "metadata": {
      "user_id": "12345",
      "order_id": "TEST-001"
    }
  }'
```

### 2. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –æ–ø–ª–∞—Ç—ã
```
Response: {
  "success": true,
  "data": {
    "payment_url": "https://byfly-pay.com/pay/TRANSACTION_ID"
  }
}
```

### 3. –û–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ Kaspi

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook.site
–î–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ –≤–µ–±—Ö—É–∫:
```json
{
  "event": "paid",
  "transaction_id": "...",
  "metadata": {
    "user_id": "12345",
    "order_id": "TEST-001"
  }
}
```

---

## üìä –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –∞–¥–º–∏–Ω–∫–µ:

1. **üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API** - –ø–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
2. **–õ–æ–≥–∏ –≤–µ–±—Ö—É–∫–æ–≤** - –≤ –¥–µ—Ç–∞–ª—è—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
3. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** - –≤–∏–¥–Ω—ã –≤ –¥–µ—Ç–∞–ª—è—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. **–ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - 1-3 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ –º–∏–Ω—É—Ç—ã

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **Lock-—Ñ–∞–π–ª** —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `api/cron/check-active-payments.lock`
   - –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–∏—Å - —É–¥–∞–ª–∏—Ç–µ –≤—Ä—É—á–Ω—É—é

2. **–õ–æ–≥–∏ –≤–µ–±—Ö—É–∫–æ–≤** —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `webhook_logs`
   - –ú–æ–∂–Ω–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ

3. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ** JSON —Ñ–æ—Ä–º–∞—Ç, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ª—é–±—ã–µ –ø–æ–ª—è

4. **–ü–æ–¥–ø–∏—Å—å –≤–µ–±—Ö—É–∫–æ–≤** HMAC-SHA256
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook_secret –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## üöÄ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å ByFly Payment Center - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π **–ø–ª–∞—Ç–µ–∂–Ω—ã–π —à–ª—é–∑** —Å:
- ‚úÖ REST API
- ‚úÖ –í–µ–±—Ö—É–∫–∏ (5 —Å–æ–±—ã—Ç–∏–π)
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (1-3 —Å–µ–∫)
- ‚úÖ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª `deploy.zip` –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!**




