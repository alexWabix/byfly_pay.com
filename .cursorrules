# ByFly Travel Payment Center - Правила проекта для Cursor AI

## Описание проекта

Центр управления платежами ByFly Travel - универсальная платежная система для приема оплат через различные платежные системы с фокусом на терминалы Kaspi.

## Архитектура

### Backend (PHP)
- **Технологии**: PHP 7.4+, MySQL, PDO
- **Структура**: REST API с модульной архитектурой
- **Безопасность**: JWT токены, SMS авторизация через smsc.kz

### Frontend (Vue.js 3)
- **Технологии**: Vue 3, Vite, Vue Router, Pinia
- **Компоненты**: SFC (Single File Components)
- **Стили**: Vanilla CSS с CSS переменными

## Структура базы данных

### Основные таблицы
1. `admins` - Администраторы с правами доступа по странам
2. `sources` - Источники API с токенами
3. `payment_methods` - Способы оплаты с настройками комиссий
4. `kaspi_terminals` - Терминалы Kaspi с привязкой к камерам
5. `transactions` - Платежные транзакции с полной историей
6. `transaction_logs` - Детальные логи всех операций

## Конфигурация

### База данных
```php
host: localhost
port: 3306
database: payments
username: payments
password: 2350298aweA
```

### SMS сервис (smsc.kz)
```php
login: Byfly2024
password: 2350298aweA!@
```

### Kaspi терминалы
- IP адреса: http://109.175.215.40, http://188.127.40.70
- Порты: 130-140
- QR камеры: API на http://109.175.215.40:3000/qr/{camera_id}

## Логика работы с Kaspi

1. **Инициализация платежа**:
   - Выбор свободного терминала
   - Отправка запроса на терминал
   - Считывание QR кода с камеры
   - Генерация ссылки для клиента

2. **Расчет комиссий**:
   - Kaspi Gold: 1%
   - Kaspi Red: 1%
   - Kaspi Kredit: 14%
   - Kaspi рассрочка: 14%
   - Комиссия добавляется к сумме

3. **Проверка статуса**:
   - Опрос терминала каждую секунду
   - При успехе - освобождение терминала
   - Отправка webhook уведомления

4. **Контроль способа оплаты**:
   - Если клиент выбрал Gold, но оплатил в кредит - показать недостачу
   - Поддержка частичной оплаты разными способами

## API Эндпоинты

### Публичные (требуют X-API-Token)
- POST `/api/payment/init` - Создание платежа
- GET `/api/payment/{id}` - Информация о платеже
- POST `/api/payment/{id}/kaspi` - Обработка через Kaspi
- GET `/api/payment/{id}/status` - Статус платежа
- POST `/api/payment/{id}/cancel` - Отмена платежа

### Админские (требуют Bearer token)
- POST `/api/auth/send-code` - Отправка SMS кода
- POST `/api/auth/verify` - Вход по коду
- GET/POST/PUT/DELETE `/api/admin/admins` - Управление админами
- GET/POST/PUT/DELETE `/api/admin/sources` - Управление источниками
- GET/POST/PUT/DELETE `/api/admin/payment-methods` - Способы оплаты
- GET/POST/PUT/DELETE `/api/admin/terminals` - Терминалы
- GET `/api/admin/transactions` - История транзакций

## Правила разработки

### PHP код
- Использовать PDO для работы с БД
- Всегда использовать prepared statements
- Обрабатывать все исключения
- Логировать все операции в transaction_logs
- Возвращать JSON ответы через класс Response

### Vue.js код
- Использовать Composition API (setup)
- Хранить состояние в Pinia stores
- API запросы через services/api.js
- Компоненты должны быть переиспользуемыми
- Следовать Vue Style Guide

### Безопасность
- Никогда не хранить пароли в открытом виде
- Валидировать все входные данные
- Использовать HTTPS в продакшене
- Ограничивать доступ по IP для критичных операций
- SMS коды истекают через 10 минут

### Работа с терминалами
- Всегда проверять доступность терминала
- Блокировать терминал перед использованием
- Освобождать терминал после операции или ошибки
- Логировать все взаимодействия с терминалами
- Обрабатывать таймауты (5-10 секунд)

## Структура файлов

```
payment_byfly/
├── api/                      # Backend API (PHP)
│   ├── config.php           # Конфигурация
│   ├── index.php            # Точка входа API
│   ├── init.php             # Инициализация БД
│   ├── includes/            # Классы PHP
│   │   ├── Database.php     # Работа с БД
│   │   ├── Response.php     # JSON ответы
│   │   ├── Auth.php         # Авторизация
│   │   ├── JWT.php          # JWT токены
│   │   ├── KaspiTerminal.php # Работа с терминалами
│   │   └── Transaction.php   # Транзакции
│   └── endpoints/           # API эндпоинты
│       ├── auth.php         # Авторизация
│       ├── payment.php      # Платежи (публичные)
│       └── admin.php        # Админка
├── src/                     # Frontend (Vue.js 3)
│   ├── main.js             # Точка входа
│   ├── App.vue             # Главный компонент
│   ├── router/             # Vue Router
│   │   └── index.js
│   ├── stores/             # Pinia stores
│   │   └── auth.js
│   ├── services/           # API сервисы
│   │   └── api.js
│   ├── components/         # Переиспользуемые компоненты
│   │   └── PhoneInput.vue  # Ввод телефона с маской
│   ├── layouts/            # Layouts
│   │   └── AdminLayout.vue # Админ layout
│   ├── views/              # Страницы
│   │   ├── Login.vue       # Авторизация
│   │   ├── Dashboard.vue   # Дашборд
│   │   ├── Transactions.vue # Транзакции
│   │   ├── Terminals.vue   # Терминалы
│   │   ├── Sources.vue     # Источники
│   │   ├── PaymentMethods.vue # Способы оплаты
│   │   └── Admins.vue      # Администраторы
│   ├── utils/              # Утилиты
│   │   └── phoneMask.js    # Маски телефонов
│   └── assets/             # Стили
│       └── main.css        # Главные стили
├── database/
│   └── schema.sql          # SQL схема БД
├── dist/                   # Собранный фронтенд
├── package.json            # npm зависимости
├── vite.config.js         # Конфиг Vite
├── build.sh               # Скрипт сборки
├── .htaccess              # Apache конфиг
├── README.md              # Документация
└── .cursorrules           # Этот файл
```

## Добавление новых платежных систем

1. Добавить запись в `payment_methods`
2. Создать класс-обработчик в `api/includes/`
3. Добавить эндпоинт в `api/endpoints/payment.php`
4. Обновить фронтенд для отображения нового способа
5. Добавить настройки комиссий в конфиг

## Тестирование

- Тестировать на дефолтном админе: +7 778 002 16 666
- Проверять работу с разными способами оплаты
- Тестировать частичную оплату
- Проверять корректность расчета комиссий
- Тестировать webhook уведомления

## Деплой

1. Собрать проект: `./build.sh`
2. Скопировать созданный ZIP на сервер
3. Распаковать в корень веб-сервера
4. Запустить `php api/init.php` для инициализации БД
5. Настроить веб-сервер (Apache/Nginx)
6. Проверить доступность по https://byfly-pay.com

## Мониторинг

- Следить за статусом терминалов
- Проверять успешность отправки SMS
- Мониторить failed транзакции
- Проверять доставку webhook
- Следить за нагрузкой на БД

## Важные заметки

1. **Терминалы Kaspi** - основной способ оплаты, требуют особого внимания
2. **Комиссии** - всегда добавляются к сумме, если включена настройка
3. **Частичная оплата** - поддерживается, клиент может платить разными способами
4. **Webhook** - критичен для интеграции, проверять подпись
5. **SMS коды** - истекают через 10 минут, максимум попыток не ограничен
6. **API токены** - 64 символа, генерируются автоматически
7. **Права доступа** - админы могут иметь доступ только к определенным странам

## Контакты

Все вопросы по проекту направлять администратору ByFly Travel.
