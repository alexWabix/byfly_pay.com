# Настройка обновления курсов валют

## Описание

Система автоматически получает курсы валют от **Национального банка РК** каждую минуту.

## API Нацбанка РК

**URL**: https://nationalbank.kz/rss/get_rates.cfm?fdate=DD.MM.YYYY  
**Формат**: XML  
**Обновление**: Ежедневно

## Настройка Cron

### 1. Откройте crontab

```bash
crontab -e
```

### 2. Добавьте задачу

```bash
# Обновление курсов валют каждую минуту
*/1 * * * * php /path/to/your/site/api/cron/update-exchange-rates.php >> /path/to/logs/exchange-rates.log 2>&1
```

**Замените** `/path/to/your/site/` на реальный путь!

### 3. Сохраните и выйдите

```
:wq  (в vim)
```

### 4. Проверьте что задача добавлена

```bash
crontab -l
```

## Ручное обновление

Для тестирования можно запустить вручную:

```bash
php /path/to/your/site/api/cron/update-exchange-rates.php
```

**Вывод**:
```
[2025-12-25 20:00:00] Starting exchange rates update...
✅ Exchange rates updated successfully
[2025-12-25 20:00:01] Finished
```

## Логирование

Все операции логируются в:
- PHP error_log
- Лог файл указанный в crontab

**Ошибки**:
- Проблемы с подключением к API
- Ошибки парсинга XML
- Проблемы с БД

## Проверка работы

### 1. Проверка в БД

```sql
SELECT * FROM exchange_rates ORDER BY fetched_at DESC;
```

Должны быть актуальные курсы с недавним `fetched_at`.

### 2. Проверка через API

```
GET https://your-site.com/api/countries/exchange-rates
```

Должен вернуть JSON с курсами.

### 3. Проверка на странице оплаты

- Выберите Узбекистан
- Сумма должна пересчитаться в сўм
- Курс обновляется автоматически

## Поддерживаемые валюты

Система автоматически получает курсы для всех валют доступных в API Нацбанка:

- **USD** - Доллар США
- **EUR** - Евро
- **RUB** - Российский рубль  
- **UZS** - Узбекский сўм
- **KGS** - Киргизский сом
- **TRY** - Турецкая лира
- **CNY** - Китайский юань
- И другие...

## Как это работает

1. **Cron запускается** каждую минуту
2. **Получает XML** от Нацбанка РК
3. **Парсит курсы** всех валют
4. **Обновляет БД** с timestamp
5. **Клиент получает** через API
6. **Автоматический пересчет** при выборе страны

## Пример конвертации

**Сумма**: 10,000 ₸ (KZT)  
**Курс**: 1 KZT = 56 UZS

**Конвертация**:
```
10,000 * 56 = 560,000 сўм
```

При выборе Узбекистана клиент увидит **560,000 сўм** вместо 10,000 ₸

## Fallback

Если курс не найден:
- Используется сумма в оригинальной валюте (KZT)
- В логах появится предупреждение

## Мониторинг

Проверяйте логи регулярно:

```bash
tail -f /path/to/logs/exchange-rates.log
```

Должны быть записи каждую минуту.

---

**Версия**: 2.1.0  
**Дата**: 25.12.2025  
**Источник курсов**: Национальный банк Республики Казахстан

